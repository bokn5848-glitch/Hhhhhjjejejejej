<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UChat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{
  background:#4a90e2;color:#fff;padding:12px;
  display:flex;justify-content:space-between;align-items:center
}
#logout{background:#ff4d4d;color:#fff;border:none;padding:6px 10px;border-radius:6px}

#chat{height:calc(100vh - 230px);overflow-y:auto;padding:10px}
.msg{
  background:#fff;padding:8px 10px;margin:6px 0;
  border-radius:14px;max-width:70%;width:fit-content;
  position:relative;word-wrap:break-word
}
.me{background:#d9ecff;margin-left:auto}
.name{font-weight:bold;color:#4a90e2;font-size:13px}
.content{white-space:pre-wrap}
.time{font-size:11px;color:#888;text-align:right}
.status{font-size:11px;color:#4a90e2;text-align:right;cursor:pointer}
.delete,.replyBtn{font-size:12px;color:#4a90e2;cursor:pointer;text-align:right}
.delete{color:red}

.replyPreview{
  font-size:13px;background:#f1f1f1;
  padding:5px 8px;border-radius:8px;margin-bottom:4px
}

/* REACTION */
.reactionBar{
  position:absolute;
  bottom:100%;
  left:10px;
  background:#fff;
  padding:6px 10px;
  border-radius:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
  display:none;
  gap:8px;
  z-index:999
}
.reactionBar span{font-size:22px;cursor:pointer}
.reactionList{display:flex;gap:6px;font-size:16px;margin-top:4px}

/* C·∫≠p nh·∫≠t CSS cho SeenBox */
.seenBox{
  position:absolute;
  right:0;bottom:100%;
  background:#fff;
  padding:8px 10px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
  font-size:13px;
  display:none;
  z-index:999;
  transform: translateY(-5px); 
}

#typing{font-size:13px;color:#666;padding:5px 10px;height:18px}

#inputBox{display:flex;flex-direction:column;padding:10px;background:#fff}
#sendRow{display:flex;gap:5px}
input{flex:1;padding:10px;font-size:16px}
button{padding:10px}

.replyBox{
  background:#eef6ff;padding:6px 10px;
  border-left:4px solid #4a90e2;
  margin-bottom:6px;font-size:14px;position:relative
}
.replyBox .close{
  position:absolute;right:6px;top:4px;cursor:pointer;color:red
}

#loginBox{text-align:center;padding:30px}
</style>
</head>

<body>

<header>
  üí¨ UChat
  <button id="logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
</header>

<div id="loginBox">
  <input id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
  <br><br>
  <button onclick="doLogin()">V√†o chat</button>
</div>

<div id="chat" style="display:none"></div>
<div id="typing"></div>

<div id="inputBox" style="display:none">
  <div id="replyArea"></div>
  <div id="sendRow">
    <input id="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button onclick="send()">G·ª≠i</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCxxxxxxxxxxxx",
  authDomain:"uchat-406f4.firebaseapp.com",
  databaseURL:"https://uchat-406f4-default-rtdb.firebaseio.com",
  projectId:"uchat-406f4"
});

const db=firebase.database().ref("uchat");
const typingRef=firebase.database().ref("typing");
const REACTIONS=["‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üò°","üëç"];

const chat=document.getElementById("chat");
const textInput=document.getElementById("text");
const replyArea=document.getElementById("replyArea");
const typing=document.getElementById("typing");

let user="",replyTo=null;

const saved=localStorage.getItem("uchat_name");
if(saved){user=saved;showChat();}

function doLogin(){
  const n=username.value.trim();
  if(!n) return alert("Nh·∫≠p t√™n!");
  user=n;localStorage.setItem("uchat_name",n);showChat();
}
function showChat(){
  loginBox.style.display="none";
  chat.style.display="block";
  inputBox.style.display="flex";
}
function logout(){
  if(!confirm("ƒêƒÉng xu·∫•t / ƒë·ªïi t√™n?"))return;
  localStorage.removeItem("uchat_name");
  user="";chat.innerHTML="";
  loginBox.style.display="block";
  chat.style.display="none";
  inputBox.style.display="none";
}

function wrap28(t){
  let o="";for(let i=0;i<t.length;i+=28)o+=t.slice(i,i+28)+"\n";
  return o.trim();
}

function send(){
  const t=textInput.value.trim();
  if(!t) return;
  db.push({name:user,msg:wrap28(t),time:Date.now(),reply:replyTo,seen:{},react:{}});
  textInput.value="";
  replyTo=null;
  replyArea.innerHTML="";
  typingRef.child(user).remove();
}

// C·∫¨P NH·∫¨T: Th√™m h√†m ƒë·ªãnh d·∫°ng ng√†y (df)
const df = t => {
  const d = new Date(t);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
};

// H√†m ƒë·ªãnh d·∫°ng gi·ªù (tf) - Gi·ªØ nguy√™n logic c≈©
const tf=t=>{
  const d=new Date(t);
  return d.getHours()+":"+String(d.getMinutes()).padStart(2,"0");
};

function confirmDelete(id){
  if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y kh√¥ng?")){
    db.child(id).remove();
  }
}

function react(id,emoji){
  const r=db.child(id).child("react").child(emoji).child(user);
  r.once("value",s=>s.exists()?r.remove():r.set(true));
}

/* RECEIVE */
db.on("child_added",snap=>{
  const d=snap.val(),k=snap.key,isMe=d.name===user;
  const div=document.createElement("div");
  div.className="msg "+(isMe?"me":"");div.id=k;

  let replyHTML=d.reply?`<div class="replyPreview"><b>${d.reply.name}</b>: ${d.reply.msg}</div>`:"";

  div.innerHTML=`
    <div class="reactionBar" id="react_${k}">
      ${REACTIONS.map(e=>`<span onclick="react('${k}','${e}')">${e}</span>`).join("")}
    </div>

    <div class="name">${d.name}</div>
    ${replyHTML}
    <div class="content">${d.msg}</div>
    <div class="reactionList" id="list_${k}"></div>
    
    <div class="time">${tf(d.time)} - ${df(d.time)}</div>

    ${isMe?`<div class="status" id="status_${k}"
        onmouseover="document.getElementById('seen_${k}').style.display='block';"
        onmouseleave="document.getElementById('seen_${k}').style.display='none';"
    >‚úîÔ∏è ƒê√£ g·ª≠i</div>`:""}
    <div class="seenBox" id="seen_${k}"></div>
    <div class="replyBtn" onclick="setReply('${k}')">‚Ü©Ô∏è Tr·∫£ l·ªùi</div>
    ${isMe?`<div class="delete" onclick="confirmDelete('${k}')">üóëÔ∏è X√≥a</div>`:""}
  `;

  div.oncontextmenu=e=>{
    e.preventDefault();
    document.querySelectorAll(".reactionBar").forEach(r=>r.style.display="none");
    document.getElementById("react_"+k).style.display="flex";
  };
  document.body.onclick=()=>document.querySelectorAll(".reactionBar").forEach(r=>r.style.display="none");

  if(!isMe){
    const obs=new IntersectionObserver(e=>{
      if(e[0].isIntersecting){
        db.child(k).child("seen").child(user).set(true);
        obs.disconnect();
      }
    },{threshold:0.6});
    obs.observe(div);
  }

  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
});

// Logic x·ª≠ l√Ω reactions v√† seen status (gi·ªØ nguy√™n)
db.on("child_changed", snap => {
  const d = snap.val(), k = snap.key;

  // X·ª≠ l√Ω Reactions
  const list = document.getElementById("list_" + k);
  if (list && d.react) {
    list.innerHTML = "";
    for (const e in d.react) {
      const c = Object.keys(d.react[e]).length;
      if (c > 0) list.innerHTML += `<span>${e} ${c}</span>`;
    }
  }

  // X·ª≠ l√Ω Tr·∫°ng th√°i ƒê√£ xem chi ti·∫øt
  const isMe = d.name === user;
  if (isMe) {
    const seenBox = document.getElementById("seen_" + k);
    const statusDiv = document.getElementById("status_" + k);
    
    if (d.seen) {
      const viewerNames = Object.keys(d.seen).filter(n => n !== d.name); 
      
      if (viewerNames.length > 0) {
        seenBox.innerText = `ƒê√£ xem b·ªüi: ${viewerNames.join(", ")}`;
        statusDiv.innerHTML = `‚úîÔ∏è ƒê√£ xem (${viewerNames.length})`; 
      } else {
        statusDiv.innerHTML = `‚úîÔ∏è ƒê√£ g·ª≠i`;
      }
    }
  }
});

db.on("child_removed",s=>document.getElementById(s.key)?.remove());

function setReply(id){
  const m=document.getElementById(id);
  replyTo={name:m.querySelector(".name").innerText,msg:m.querySelector(".content").innerText};
  replyArea.innerHTML=`<div class="replyBox">Tr·∫£ l·ªùi <b>${replyTo.name}</b>: ${replyTo.msg}<span class="close" onclick="cancelReply()">‚úñ</span></div>`;
}
function cancelReply(){replyTo=null;replyArea.innerHTML="";}

let tmr;
textInput.oninput=()=>{
  typingRef.child(user).set(true);
  clearTimeout(tmr);
  tmr=setTimeout(()=>typingRef.child(user).remove(),1200);
};
typingRef.on("value",s=>{
  const o=Object.keys(s.val()||{}).filter(n=>n!==user);
  typing.innerText=o.length?o.join(", ")+" ƒëang g√µ...":"";
});
</script>

</body>
</html>
